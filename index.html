<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fair Use Evaluation Tool</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #f0f3fa;
    --card-bg:#ffffff;
    --primary:#4A83F7;
    --accent:#6BCB77;
    --text:#1a1a1a;
    --shadow:0 6px 14px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; }
  body{
    font-family: "Inter", sans-serif;
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--text);
  }

  /* NAVBAR */
  .navbar {
    display:flex;
    gap:28px;
    padding:18px 40px;
    background:#ffffffdd;
    backdrop-filter:blur(6px);
    box-shadow:var(--shadow);
    position:sticky;
    top:0;
    z-index:200;
  }
  .nav-item{
    cursor:pointer;
    font-size:16px;
    color:#243153;
    text-decoration:none;
    font-weight:600;
  }
  .nav-item:hover{ text-decoration:underline; }

  .section{
    display:none;
    max-width:960px;
    margin:auto;
    padding:30px 20px 60px;
  }
  .section.active{
    display:block;
  }

  /* EVERYTHING BELOW IS YOUR ORIGINAL STYLING — UNCHANGED */
  h1{
    text-align:center;
    font-weight:700;
    font-size:34px;
    margin-bottom:10px;
  }
  .subtitle{
    text-align:center;
    font-size:16px;
    opacity:0.8;
    margin-bottom:24px;
  }
  .intro-card{
    background:var(--card-bg);
    padding:18px 20px;
    border-radius:12px;
    box-shadow:var(--shadow);
    margin-bottom:24px;
    font-size:14px;
    line-height:1.6;
  }
  .intro-card h2{ margin-top:0; font-size:18px; margin-bottom:8px; }
  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    background:#e3ebff;
    color:#28408f;
    margin-bottom:6px;
  }
  .question-block{
    margin-bottom:18px;
    padding:16px 18px;
    border-radius:12px;
    background:var(--card-bg);
    box-shadow:var(--shadow);
  }
  .question-label{ font-size:15px; margin-bottom:6px; }
  input[type=range]{ width:100%; accent-color:var(--primary); }
  .label-row{
    display:flex; justify-content:space-between;
    font-size:13px; margin-top:6px; opacity:.65;
  }
  .score-value{ font-weight:700; }
  button{
    padding:14px 48px; font-size:16px; border:none; border-radius:10px;
    background:var(--primary); color:white; cursor:pointer;
    display:block; margin:26px auto 0 auto; transition:.2s; box-shadow:var(--shadow);
  }
  button:hover{ background:#345fd2; transform:translateY(-2px); }

  #result{ margin-top:32px; }

  .results-card{
    padding:32px; background:linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
    border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
    margin-bottom:24px; border:2px solid #e3ebff;
  }
  .results-title{ font-size:24px; font-weight:700; margin-bottom:12px; }
  .results-sub{ font-size:14px; opacity:.8; margin-bottom:20px; }
  .score-row{
    display:flex; justify-content:space-between; align-items:center;
    margin-top:6px; margin-bottom:6px; font-size:16px;
  }
  .score-label{ font-weight:600; }
  .score-number{ font-weight:700; font-size:18px; }
  .bar-container{
    width:100%; background:#d8dee9; border-radius:999px;
    margin:12px 0 4px 0; height:18px; overflow:hidden;
  }
  .bar{
    height:100%; border-radius:999px;
    background: linear-gradient(90deg, #ff5757, #ffcb57, #57ff9a);
    transition:width .6s;
  }
  .overall-description{ font-size:16px; margin-top:16px; line-height:1.7; font-weight:500; }
  .disclaimer{ font-size:12px; opacity:0.7; margin-top:12px; }

  .factor-block{
    margin-top:16px; padding:14px 16px; 
    background:linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
    border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.06);
    border:1px solid #e8eef5;
  }
  .factor-block .bar-container{
    height:10px; margin:8px 0 2px 0;
  }
  .factor-block .bar{
    background: linear-gradient(90deg, #6b7fc8, #7aa3d4, #5fb3e8);
  }
  .factor-title{ font-size:15px; margin-bottom:5px; font-weight:600; }
  .factor-tagline{ font-size:11px; opacity:.7; margin-bottom:8px; }
  .factor-text{ font-size:12px; line-height:1.5; margin-top:6px; }

  /* Training Data Section */
  .case-name-input{
    width:100%; padding:12px; font-size:15px; border:2px solid #d8dee9;
    border-radius:8px; margin-bottom:20px; font-family:inherit;
  }
  .label-selection{
    display:flex; gap:20px; margin:20px 0; justify-content:center;
  }
  .label-option{
    padding:12px 24px; border:2px solid #d8dee9; border-radius:8px;
    cursor:pointer; background:var(--card-bg); transition:.2s;
    font-weight:600;
  }
  .label-option:hover{ border-color:var(--primary); background:#f0f3fa; }
  .label-option.selected{
    border-color:var(--primary); background:var(--primary); color:white;
  }
  .label-option.selected[data-label="0"]{ background:#ff5757; border-color:#ff5757; }
  .label-option.selected[data-label="1"]{ background:#6BCB77; border-color:#6BCB77; }
  .save-message{
    margin-top:16px; padding:12px; border-radius:8px; display:none;
    font-weight:600;
  }
  .save-message.success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; display:block; }
  .save-message.error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; display:block; }

  /* Admin Section */
  .admin-controls{
    display:flex; gap:12px; margin-bottom:20px; align-items:center;
  }
  .cases-list{
    margin-top:20px;
  }
  .case-item{
    background:var(--card-bg); padding:16px; border-radius:12px;
    box-shadow:var(--shadow); margin-bottom:12px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .case-info h3{ margin:0 0 8px 0; font-size:16px; }
  .case-info p{ margin:4px 0; font-size:13px; opacity:.7; }
  .case-actions{
    display:flex; gap:8px;
  }
  .btn-delete{
    padding:8px 16px; background:#ff5757; color:white; border:none;
    border-radius:6px; cursor:pointer; font-weight:600; transition:.2s;
  }
  .btn-delete:hover{ background:#e04343; }
  .btn-train{
    padding:10px 20px; background:var(--primary); color:white; border:none;
    border-radius:8px; cursor:pointer; font-weight:600; transition:.2s;
  }
  .btn-train:hover{ background:#345fd2; }
  .btn-train:disabled{ background:#ccc; cursor:not-allowed; }
  .btn-export{
    padding:10px 20px; background:var(--accent); color:white; border:none;
    border-radius:8px; cursor:pointer; font-weight:600; transition:.2s;
    margin-left:auto;
  }
  .btn-export:hover{ background:#5ab868; }
  .stats{
    background:var(--card-bg); padding:16px; border-radius:12px;
    box-shadow:var(--shadow); margin-bottom:20px;
    display:flex; gap:24px; flex-wrap:wrap;
  }
  .stat-item{
    text-align:center;
  }
  .stat-number{ font-size:24px; font-weight:700; color:var(--primary); }
  .stat-label{ font-size:12px; opacity:.7; margin-top:4px; }

</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <a class="nav-item" onclick="showTab('quiz')">Quiz</a>
  <a class="nav-item" onclick="showTab('training')">Training Data</a>
  <a class="nav-item" onclick="showTab('admin')">Admin</a>
  <a class="nav-item" onclick="showTab('resources')">Resources</a>
  <a class="nav-item" onclick="showTab('process')">Process</a>
</div>




<!-- QUIZ SECTION -->
<div id="quiz" class="section active">
  <h1>Fair Use Evaluation Tool</h1>
  <div class="subtitle">
    Answer a few questions to get an educational, non-binding sense of how your use might align with U.S. fair use principles.
  </div>

  <div class="intro-card">
    <div class="badge">What is fair use?</div>
    <h2>A quick, plain-language overview</h2>
    <p>
      Under U.S. copyright law, <b>fair use</b> is a flexible doctrine that sometimes allows you to use someone else’s copyrighted work
      without permission...
    </p>
    <p>
      This tool walks through the four traditional fair use factors...
    </p>
    <p>
      Slide each question from <b>1</b> (least supportive of fair use) to <b>9</b> (most supportive)...
    </p>
  </div>
  <div id="questionContainer"></div>
  <button type="button" onclick="calculateScore()">Evaluate Fair Use</button>
  <div id="result"></div>
</div>


<!-- RESOURCES SECTION -->
<div id="resources" class="section">
  <h1>Learn More</h1>
  <ul>
    <li><a href="https://fairuse.stanford.edu/" target="_blank">Stanford Fair Use Center</a></li>
    <li><a href="https://www.copyright.gov/fair-use/" target="_blank">U.S. Copyright Office</a></li>
    <li><a href="https://www.law.cornell.edu/uscode/text/17/107" target="_blank">17 USC §107</a></li>
  </ul>
</div>


<!-- PROCESS SECTION -->
<div id="process" class="section">
  <h1>How Your Score is Calculated</h1>
  <p>Manual scoring and ML model explanation go here. (Educational only.)</p>
</div>


<!-- TRAINING DATA SECTION -->
<div id="training" class="section">
  <h1>Add Training Data</h1>
  <div class="subtitle">
    Enter a court case with its answers and label (fair use or not fair use) to build your training dataset.
  </div>

  <div class="intro-card">
    <h2>Instructions</h2>
    <p>
      <b>1.</b> Enter the name of the court case (e.g., "Campbell v. Acuff-Rose Music, 510 U.S. 569 (1994)")<br>
      <b>2.</b> Answer all 25 questions based on how the court case was decided<br>
      <b>3.</b> Select whether the case was ruled as <b>Fair Use</b> or <b>Not Fair Use</b><br>
      <b>4.</b> Click "Save Case" to add it to the database
    </p>
  </div>

  <input type="text" id="caseNameInput" class="case-name-input" placeholder="Enter case name (e.g., Campbell v. Acuff-Rose Music, 510 U.S. 569 (1994))">

  <div class="label-selection">
    <div class="label-option" data-label="1" onclick="selectLabel(1)">
      ✓ Fair Use
    </div>
    <div class="label-option" data-label="0" onclick="selectLabel(0)">
      ✗ Not Fair Use
    </div>
  </div>

  <div id="trainingQuestionContainer"></div>
  <button type="button" onclick="saveTrainingCase()">Save Case</button>
  <div id="saveMessage" class="save-message"></div>
</div>


<!-- ADMIN SECTION -->
<div id="admin" class="section">
  <h1>Admin - View Training Data</h1>
  <div class="subtitle">
    View, manage, and export your training dataset.
  </div>

  <div class="admin-controls">
    <button type="button" onclick="loadAdminData()">Refresh Data</button>
    <button type="button" class="btn-train" onclick="trainModel()">Train Model</button>
    <button type="button" class="btn-export" onclick="exportTrainingData()">Export JSON</button>
  </div>
  <div id="trainMessage" class="save-message"></div>

  <div id="statsContainer" class="stats"></div>
  <div id="casesContainer" class="cases-list"></div>
</div>


<script>
function showTab(tab){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  if(tab === 'admin'){
    loadAdminData();
  }
  if(tab === 'training'){
    // Reset training form when switching to it
    document.getElementById('caseNameInput').value = '';
    selectedLabel = null;
    document.querySelectorAll('.label-option').forEach(opt => opt.classList.remove('selected'));
    renderTrainingQuestions();
  }
}
</script>


<!-- ALL YOUR ORIGINAL JAVASCRIPT EXACTLY BELOW -->
<script>
/* === EVERYTHING from your long script remains unchanged === */
/* paste your ENTIRE JS code here — from INTRO through scoring */
/* (it continues exactly as in your version, unchanged) */

// =====================================================
// CONFIGURATION
// =====================================================

// Plain-English question texts (1–25)
const questionTexts = {
  // Factor 1: Purpose & Character
  1: "How much does your use add new meaning or purpose compared to the original?",
  2: "To what extent would an ordinary viewer see your use as transformative rather than just copying?",
  3: "Does your use mainly comment on, critique, or analyze the original work?",
  4: "How strongly is your use connected to education, research, scholarship, or review?",
  5: "How different is your purpose from the original creator’s purpose for the work?",

  // Factor 2: Nature of the Work
  6: "Is the original work more factual, informational, or documentary than creative or expressive?",
  7: "Is the original material widely available to the public (for example, published or posted)?",
  8: "Does your use focus more on facts, data, or information than on artistic or expressive elements?",
  9: "Would the public benefit from better understanding the material you are using?",
  10:"Is the original work already published rather than an unpublished draft or private work?",

  // Factor 3: Amount & Substantiality
  11:"How small a portion of the original are you using relative to the whole work?",
  12:"Did you avoid taking the most memorable or central “heart” of the original work?",
  13:"Is the amount you used no more than necessary to make your point or achieve your purpose?",
  14:"Did you make a deliberate effort to limit copying instead of taking extra material “just in case”?",
  15:"Could your project still work if you used slightly less of the original work?",

  // Factor 4: Market Effect
  16:"Does your use avoid substituting for or replacing the original work for most audiences?",
  17:"Is it unlikely that your use will reduce sales, licensing opportunities, or views for the original?",
  18:"Does your project target a clearly different audience, context, or use than the original?",
  19:"Is it unlikely that the original creator or publisher will lose meaningful income because of your use?",
  20:"Are people who see your work still likely to seek out or pay for the original if they want it?",

  // Factor 5: Other considerations
  21:"Are you acting in good faith—for example, not trying to pass the work off as entirely your own?",
  22:"Did you avoid adding elements that are misleading, offensive, or likely to be viewed as bad-faith use?",
  23:"Have you clearly distinguished your work from the original creator (for example, through context or labeling)?",
  24:"Have you avoided suggesting or implying that the original creator sponsors or endorses your project?",
  25:"Did you use only what felt genuinely necessary rather than copying out of convenience or habit?"
};

// Reverse-scored questions (1..25) if any (e.g., where 9 is worst, 1 is best)
const reverseQuestions = [
  // Example: 15, 19
];

// Weights for each question (index 1..25)
const weights = Array(26).fill(1);

// Factor 1 (Purpose & Character)
weights[1] = 3;
weights[2] = 3;
weights[3] = 3;
weights[4] = 2;
weights[5] = 2;

// Factor 2 (Nature of the Work)
weights[6] = 2;
weights[7] = 1;
weights[8] = 1;
weights[9] = 1;
weights[10] = 2;

// Factor 3 (Amount & Substantiality)
weights[11] = 2;
weights[12] = 2;
weights[13] = 2;
weights[14] = 2;
weights[15] = 1;

// Factor 4 (Market Effect)
weights[16] = 3;
weights[17] = 3;
weights[18] = 2;
weights[19] = 3;
weights[20] = 3;

// Factor 5 (Other considerations)
weights[21] = 1;
weights[22] = 1;
weights[23] = 2;
weights[24] = 2;
weights[25] = 1;

// Factor groupings (you can change which questions belong to which factor)
const factorAssignments = {
  purpose: [1,2,3,4,5],
  nature:  [6,7,8,9,10],
  amount:  [11,12,13,14,15],
  market:  [16,17,18,19,20],
  other:   [21,22,23,24,25]
};

const factorMeta = {
  purpose: {
    title: "Factor 1 — Purpose & Character of the Use",
    tagline: "How transformative and goal-driven your use is."
  },
  nature: {
    title: "Factor 2 — Nature of the Copyrighted Work",
    tagline: "How factual, published, and information-oriented the source is."
  },
  amount: {
    title: "Factor 3 — Amount & Substantiality",
    tagline: "How much you took and whether you avoided the core of the work."
  },
  market: {
    title: "Factor 4 — Effect on the Market",
    tagline: "Whether your use competes with or harms the original’s market."
  },
  other: {
    title: "Other Fair Use Considerations",
    tagline: "Good faith, clarity, and how your use might be perceived."
  }
};

// Per-factor descriptions
const factorDescriptions = {
  purpose: {
    low:  "Your answers suggest the purpose and character...",
    med:  "Your use is partly transformative...",
    high: "Your answers indicate a strongly transformative..."
  },
  nature: {
    low:  "You appear to be using creative, expressive...",
    med:  "The work you are using is partly factual...",
    high: "You seem to be using mainly factual..."
  },
  amount: {
    low:  "You are using a large amount...",
    med:  "You have limited your use somewhat...",
    high: "You appear to use a relatively small portion..."
  },
  market: {
    low:  "Your use may substitute for the original...",
    med:  "It’s not clear whether your use will meaningfully affect the market...",
    high: "Your use seems unlikely to replace the original..."
  },
  other: {
    low:  "Your answers suggest potential concerns...",
    med:  "You appear to be acting in reasonably good faith...",
    high: "You seem to be acting in good faith..."
  }
};

// Overall descriptions
const overallDescriptions = {
  low:  "Based on your answers, your use appears unlikely...",
  med:  "Your answers suggest a borderline situation...",
  high: "Overall, your answers describe a use that aligns..."
};

// =====================================================
// RENDER QUESTIONS
// =====================================================

function renderQuestions() {
  const container = document.getElementById("questionContainer");
  for (let i = 1; i <= 25; i++) {
    const block = document.createElement("div");
    block.className = "question-block";
    block.innerHTML = `
      <div class="question-label"><b>Q${i}.</b> ${questionTexts[i]}</div>
      <input type="range" min="1" max="9" value="5" id="q${i}"
             oninput="document.getElementById('v${i}').innerText=this.value">
      <div class="label-row">
        <span>1 (less supportive)</span>
        <span class="score-value" id="v${i}">5</span>
        <span>9 (more supportive)</span>
      </div>
    `;
    container.appendChild(block);
  }
}

renderQuestions();

// =====================================================
// SCORING
// =====================================================

async function calculateScore() {
  const original = [];
  const normalized = [];

  // collect answers
  for (let i = 1; i <= 25; i++) {
    let val = parseFloat(document.getElementById("q" + i).value);
    if (isNaN(val)) val = 5;
    original.push(val);

    let norm = reverseQuestions.includes(i) ? 10 - val : val;
    normalized.push(norm);
  }

  // manual overall score (0–100)
  let weightedSum = 0;
  let totalWeight = 0;
  for (let i = 1; i <= 25; i++) {
    weightedSum += normalized[i-1] * weights[i];
    totalWeight += weights[i];
  }
  const minPossible = 1 * totalWeight;
  const maxPossible = 9 * totalWeight;
  const manualPercent = ((weightedSum - minPossible) / (maxPossible - minPossible)) * 100;

  // call ML backend
  let mlPercent = NaN;
  try {
    const response = await fetch("/predict", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers: original })
    });
    const mlResult = await response.json();
    mlPercent = mlResult.score * 100;
  } catch (_) {
    mlPercent = NaN;
  }

  // per-factor scores
  const factorScores = {};
  for (const key in factorAssignments) {
    const qList = factorAssignments[key];
    let wSum = 0, wTot = 0;
    for (const q of qList) {
      wSum += normalized[q-1] * weights[q];
      wTot += weights[q];
    }
    const fMin = 1 * wTot;
    const fMax = 9 * wTot;
    factorScores[key] = ((wSum - fMin) / (fMax - fMin)) * 100;
  }

  // overall description
  let overallText;
  if (manualPercent < 33.333) overallText = overallDescriptions.low;
  else if (manualPercent < 66.666) overallText = overallDescriptions.med;
  else overallText = overallDescriptions.high;

  // build result HTML
  let html = `
    <div class="results-card">
      <div class="results-title">Overall Fair Use Snapshot</div>
      <div class="results-sub">These scores are educational only and do not constitute legal advice.</div>

      <div class="score-row">
        <div class="score-label">Manual score (based on your answers):</div>
        <div class="score-number">${manualPercent.toFixed(1)}%</div>
      </div>
      <div class="bar-container">
        <div class="bar" style="width:${Math.max(0, Math.min(100, manualPercent))}%;"></div>
      </div>
  `;

  if (!Number.isNaN(mlPercent)) {
    html += `
      <div class="score-row">
        <div class="score-label">AI model score (0–100):</div>
        <div class="score-number">${mlPercent.toFixed(1)}%</div>
      </div>
      <div class="bar-container">
        <div class="bar" style="width:${Math.max(0, Math.min(100, mlPercent))}%;"></div>
      </div>
    `;
  } else {
    html += `
      <div class="score-row">
        <div class="score-label">AI model score:</div>
        <div class="score-number" style="opacity:0.7;">not available (server not running)</div>
      </div>
    `;
  }

  html += `
      <div class="overall-description">${overallText}</div>
      <div class="disclaimer">
        This tool is for teaching and discussion only. Only a court can make a binding fair use determination.
      </div>
    </div>
  `;

  // add factor blocks
  for (const key in factorScores) {
    const p = factorScores[key];
    const desc = p < 33.333 ? factorDescriptions[key].low :
                 p < 66.666 ? factorDescriptions[key].med : factorDescriptions[key].high;
    const meta = factorMeta[key];

    html += `
      <div class="factor-block">
        <div class="factor-title">${meta.title}</div>
        <div class="factor-tagline">${meta.tagline}</div>
        <div class="score-row">
          <div class="score-label">Score for this factor:</div>
          <div class="score-number">${p.toFixed(1)}%</div>
        </div>
        <div class="bar-container">
          <div class="bar" style="width:${Math.max(0, Math.min(100, p))}%;"></div>
        </div>
        <div class="factor-text">${desc}</div>
      </div>
    `;
  }

  document.getElementById("result").innerHTML = html;
}

// =====================================================
// TRAINING DATA FUNCTIONS
// =====================================================

let selectedLabel = null;

function renderTrainingQuestions() {
  const container = document.getElementById("trainingQuestionContainer");
  container.innerHTML = ''; // Clear existing
  for (let i = 1; i <= 25; i++) {
    const block = document.createElement("div");
    block.className = "question-block";
    block.innerHTML = `
      <div class="question-label"><b>Q${i}.</b> ${questionTexts[i]}</div>
      <input type="range" min="1" max="9" value="5" id="tq${i}"
             oninput="document.getElementById('tv${i}').innerText=this.value">
      <div class="label-row">
        <span>1 (less supportive)</span>
        <span class="score-value" id="tv${i}">5</span>
        <span>9 (more supportive)</span>
      </div>
    `;
    container.appendChild(block);
  }
}

function selectLabel(label) {
  selectedLabel = label;
  document.querySelectorAll('.label-option').forEach(opt => {
    opt.classList.remove('selected');
    if(parseInt(opt.dataset.label) === label) {
      opt.classList.add('selected');
    }
  });
}

async function saveTrainingCase() {
  const caseName = document.getElementById('caseNameInput').value.trim();
  if (!caseName) {
    showSaveMessage('Please enter a case name', 'error');
    return;
  }
  if (selectedLabel === null) {
    showSaveMessage('Please select whether this is Fair Use or Not Fair Use', 'error');
    return;
  }

  const answers = [];
  for (let i = 1; i <= 25; i++) {
    const val = parseFloat(document.getElementById(`tq${i}`).value);
    answers.push(isNaN(val) ? 5 : val);
  }

  try {
    const response = await fetch('/api/add-case', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        case_name: caseName,
        answers: answers,
        label: selectedLabel
      })
    });

    const result = await response.json();
    if (response.ok) {
      showSaveMessage(`✓ Case saved successfully! (ID: ${result.id})`, 'success');
      // Reset form
      document.getElementById('caseNameInput').value = '';
      selectedLabel = null;
      document.querySelectorAll('.label-option').forEach(opt => opt.classList.remove('selected'));
      renderTrainingQuestions();
    } else {
      showSaveMessage(`Error: ${result.error}`, 'error');
    }
  } catch (error) {
    showSaveMessage(`Error: Could not connect to server. Make sure Flask is running.`, 'error');
  }
}

function showSaveMessage(message, type) {
  const msgDiv = document.getElementById('saveMessage');
  msgDiv.textContent = message;
  msgDiv.className = `save-message ${type}`;
  setTimeout(() => {
    msgDiv.className = 'save-message';
  }, 5000);
}

// =====================================================
// ADMIN FUNCTIONS
// =====================================================

async function loadAdminData() {
  try {
    const response = await fetch('/api/cases');
    const result = await response.json();
    
    if (!response.ok) {
      document.getElementById('casesContainer').innerHTML = `<p style="color:#ff5757;">Error: ${result.error}</p>`;
      return;
    }

    const cases = result.cases;
    
    // Update stats
    const totalCases = cases.length;
    const fairUseCount = cases.filter(c => c.label === 1).length;
    const notFairUseCount = cases.filter(c => c.label === 0).length;
    
    document.getElementById('statsContainer').innerHTML = `
      <div class="stat-item">
        <div class="stat-number">${totalCases}</div>
        <div class="stat-label">Total Cases</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:#6BCB77;">${fairUseCount}</div>
        <div class="stat-label">Fair Use</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:#ff5757;">${notFairUseCount}</div>
        <div class="stat-label">Not Fair Use</div>
      </div>
    `;

    // Display cases
    if (cases.length === 0) {
      document.getElementById('casesContainer').innerHTML = `
        <div style="text-align:center; padding:40px; opacity:0.7;">
          No cases in database yet. Add some in the Training Data tab!
        </div>
      `;
      return;
    }

    let html = '';
    cases.forEach(c => {
      const date = new Date(c.created_at).toLocaleString();
      const labelText = c.label === 1 ? '<span style="color:#6BCB77; font-weight:600;">✓ Fair Use</span>' : 
                                       '<span style="color:#ff5757; font-weight:600;">✗ Not Fair Use</span>';
      html += `
        <div class="case-item">
          <div class="case-info">
            <h3>${c.case_name}</h3>
            <p>${labelText}</p>
            <p>Added: ${date} | ID: ${c.id}</p>
          </div>
          <div class="case-actions">
            <button class="btn-delete" onclick="deleteCase(${c.id})">Delete</button>
          </div>
        </div>
      `;
    });
    document.getElementById('casesContainer').innerHTML = html;

  } catch (error) {
    document.getElementById('casesContainer').innerHTML = `
      <p style="color:#ff5757;">Error: Could not connect to server. Make sure Flask is running.</p>
    `;
  }
}

async function deleteCase(caseId) {
  if (!confirm('Are you sure you want to delete this case?')) {
    return;
  }

  try {
    const response = await fetch(`/api/cases/${caseId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    if (response.ok) {
      loadAdminData(); // Refresh the list
    } else {
      alert(`Error: ${result.error}`);
    }
  } catch (error) {
    alert('Error: Could not connect to server.');
  }
}

async function trainModel() {
  const trainBtn = document.querySelector('.btn-train');
  const msgDiv = document.getElementById('trainMessage');
  
  if (!confirm('Train the logistic regression model on all current training data? This may take a few seconds.')) {
    return;
  }
  
  trainBtn.disabled = true;
  trainBtn.textContent = 'Training...';
  msgDiv.textContent = 'Training model, please wait...';
  msgDiv.className = 'save-message';
  msgDiv.style.display = 'block';
  
  try {
    const response = await fetch('/api/train-model', {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      msgDiv.textContent = '✓ Model trained successfully! You can now use AI predictions in the Quiz tab.';
      msgDiv.className = 'save-message success';
      
      // Show training output if available
      if (result.output) {
        console.log('Training output:', result.output);
      }
    } else {
      const errorMsg = result.error || 'Training failed';
      const output = result.output || 'No output available';
      msgDiv.textContent = `Error: ${errorMsg}`;
      msgDiv.className = 'save-message error';
      console.error('Training failed:', errorMsg);
      console.error('Output:', output);
      
      // Show output in alert if available (truncate if too long)
      if (output && output.trim()) {
        const shortOutput = output.length > 500 ? output.substring(0, 500) + '...' : output;
        alert(`Training Error:\n\n${shortOutput}`);
      }
    }
  } catch (error) {
    msgDiv.textContent = 'Error: Could not connect to server. Make sure Flask is running.';
    msgDiv.className = 'save-message error';
  } finally {
    trainBtn.disabled = false;
    trainBtn.textContent = 'Train Model';
    setTimeout(() => {
      msgDiv.style.display = 'none';
    }, 10000);
  }
}

async function exportTrainingData() {
  try {
    const response = await fetch('/api/export-cases');
    const result = await response.json();
    
    if (!response.ok) {
      alert(`Error: ${result.error}`);
      return;
    }

    // Create downloadable JSON file
    const dataStr = JSON.stringify(result, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `training_data_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    alert(`Exported ${result.count} cases successfully!`);
  } catch (error) {
    alert('Error: Could not connect to server.');
  }
}

</script>

</body>
</html>
