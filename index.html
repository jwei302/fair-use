<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fair Use Evaluation Tool</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #f0f3fa;
    --card-bg:#ffffff;
    --primary:#4A83F7;
    --accent:#6BCB77;
    --text:#1a1a1a;
    --shadow:0 6px 14px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; }
  body{
    font-family: "Inter", sans-serif;
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--text);
  }

  /* NAVBAR */
  .navbar {
    display:flex;
    gap:28px;
    padding:18px 40px;
    background:#ffffffdd;
    backdrop-filter:blur(6px);
    box-shadow:var(--shadow);
    position:sticky;
    top:0;
    z-index:200;
  }
  .nav-item{
    cursor:pointer;
    font-size:16px;
    color:#243153;
    text-decoration:none;
    font-weight:600;
  }
  .nav-item:hover{ text-decoration:underline; }

  .section{
    display:none;
    max-width:960px;
    margin:auto;
    padding:30px 20px 60px;
  }
  .section.active{
    display:block;
  }

  /* EVERYTHING BELOW IS YOUR ORIGINAL STYLING — UNCHANGED */
  h1{
    text-align:center;
    font-weight:700;
    font-size:34px;
    margin-bottom:10px;
  }
  .subtitle{
    text-align:center;
    font-size:16px;
    opacity:0.8;
    margin-bottom:24px;
  }
  .intro-card{
    background:var(--card-bg);
    padding:18px 20px;
    border-radius:12px;
    box-shadow:var(--shadow);
    margin-bottom:24px;
    font-size:14px;
    line-height:1.6;
  }
  .intro-card h2{ margin-top:0; font-size:18px; margin-bottom:8px; }
  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    background:#e3ebff;
    color:#28408f;
    margin-bottom:6px;
  }
  .question-block{
    margin-bottom:18px;
    padding:16px 18px;
    border-radius:12px;
    background:var(--card-bg);
    box-shadow:var(--shadow);
  }
  .question-label{ font-size:15px; margin-bottom:6px; }
  input[type=range]{ width:100%; accent-color:var(--primary); }
  .label-row{
    display:flex; justify-content:space-between;
    font-size:13px; margin-top:6px; opacity:.65;
  }
  .score-value{ font-weight:700; }
  button{
    padding:14px 48px; font-size:16px; border:none; border-radius:10px;
    background:var(--primary); color:white; cursor:pointer;
    display:block; margin:26px auto 0 auto; transition:.2s; box-shadow:var(--shadow);
  }
  button:hover{ background:#345fd2; transform:translateY(-2px); }

  #result{ margin-top:32px; }

  .results-card{
    padding:32px; background:linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
    border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
    margin-bottom:24px; border:2px solid #e3ebff;
  }
  .results-title{ font-size:24px; font-weight:700; margin-bottom:12px; }
  .results-sub{ font-size:14px; opacity:.8; margin-bottom:20px; }
  .score-row{
    display:flex; justify-content:space-between; align-items:center;
    margin-top:6px; margin-bottom:6px; font-size:16px;
  }
  .score-label{ font-weight:600; }
  .score-number{ font-weight:700; font-size:18px; }
  .bar-container{
    width:100%; background:#d8dee9; border-radius:999px;
    margin:12px 0 4px 0; height:18px; overflow:hidden;
  }
  .bar{
    height:100%; border-radius:999px;
    background: linear-gradient(90deg, #ff5757, #ffcb57, #57ff9a);
    transition:width .6s;
  }
  .overall-description{ font-size:16px; margin-top:16px; line-height:1.7; font-weight:500; }
  .disclaimer{ font-size:12px; opacity:0.7; margin-top:12px; }

  .factor-block{
    margin-top:16px; padding:14px 16px; 
    background:linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
    border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.06);
    border:1px solid #e8eef5;
  }
  .factor-block .bar-container{
    height:10px; margin:8px 0 2px 0;
  }
  .factor-block .bar{
    background: linear-gradient(90deg, #6b7fc8, #7aa3d4, #5fb3e8);
  }
  .factor-title{ font-size:15px; margin-bottom:5px; font-weight:600; }
  .factor-tagline{ font-size:11px; opacity:.7; margin-bottom:8px; }
  .factor-text{ font-size:12px; line-height:1.5; margin-top:6px; }

  /* Training Data Section */
  .case-name-input{
    width:100%; padding:12px; font-size:15px; border:2px solid #d8dee9;
    border-radius:8px; margin-bottom:20px; font-family:inherit;
  }
  .label-selection{
    display:flex; gap:20px; margin:20px 0; justify-content:center;
  }
  .label-option{
    padding:12px 24px; border:2px solid #d8dee9; border-radius:8px;
    cursor:pointer; background:var(--card-bg); transition:.2s;
    font-weight:600;
  }
  .label-option:hover{ border-color:var(--primary); background:#f0f3fa; }
  .label-option.selected{
    border-color:var(--primary); background:var(--primary); color:white;
  }
  .label-option.selected[data-label="0"]{ background:#ff5757; border-color:#ff5757; }
  .label-option.selected[data-label="1"]{ background:#6BCB77; border-color:#6BCB77; }
  .save-message{
    margin-top:16px; padding:12px; border-radius:8px; display:none;
    font-weight:600;
  }
  .save-message.success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; display:block; }
  .save-message.error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; display:block; }

  /* Admin Section */
  .admin-controls{
    display:flex; gap:12px; margin-bottom:20px; align-items:center;
  }
  .cases-list{
    margin-top:20px;
  }
  .case-item{
    background:var(--card-bg); padding:16px; border-radius:12px;
    box-shadow:var(--shadow); margin-bottom:12px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .case-info h3{ margin:0 0 8px 0; font-size:16px; }
  .case-info p{ margin:4px 0; font-size:13px; opacity:.7; }
  .case-actions{
    display:flex; gap:8px;
  }
  .btn-delete{
    padding:8px 16px; background:#ff5757; color:white; border:none;
    border-radius:6px; cursor:pointer; font-weight:600; transition:.2s;
  }
  .btn-delete:hover{ background:#e04343; }
  .btn-train{
    padding:10px 20px; background:var(--primary); color:white; border:none;
    border-radius:8px; cursor:pointer; font-weight:600; transition:.2s;
  }
  .btn-train:hover{ background:#345fd2; }
  .btn-train:disabled{ background:#ccc; cursor:not-allowed; }
  .btn-export{
    padding:10px 20px; background:var(--accent); color:white; border:none;
    border-radius:8px; cursor:pointer; font-weight:600; transition:.2s;
    margin-left:auto;
  }
  .btn-export:hover{ background:#5ab868; }
  .stats{
    background:var(--card-bg); padding:16px; border-radius:12px;
    box-shadow:var(--shadow); margin-bottom:20px;
    display:flex; gap:24px; flex-wrap:wrap;
  }
  .stat-item{
    text-align:center;
  }
  .stat-number{ font-size:24px; font-weight:700; color:var(--primary); }
  .stat-label{ font-size:12px; opacity:.7; margin-top:4px; }

</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <a class="nav-item" onclick="showTab('quiz')">Quiz</a>
  <a class="nav-item" onclick="showTab('training')">Training Data</a>
  <a class="nav-item" onclick="showTab('admin')">Admin</a>
  <a class="nav-item" onclick="showTab('resources')">Resources</a>
  <a class="nav-item" onclick="showTab('process')">Process</a>
</div>




<!-- QUIZ SECTION -->
<div id="quiz" class="section active">
  <h1>Fair Use Evaluation Tool</h1>
  <div class="subtitle">
    Answer a few questions to get an educational, non-binding sense of how your use might align with U.S. fair use principles.
  </div>

  <div class="intro-card">
    <div class="badge">What is fair use?</div>
    <h2>A quick, plain-language overview</h2>
    <p>
      Under U.S. copyright law, <b>fair use</b> is a flexible doctrine that sometimes allows you to use someone else’s copyrighted work
      without permission...
    </p>
    <p>
      This tool walks through the four traditional fair use factors...
    </p>
    <p>
      Slide each question from <b>1</b> (least supportive of fair use) to <b>9</b> (most supportive)...
    </p>
  </div>
  <div id="questionContainer"></div>
  <button type="button" onclick="calculateScore()">Evaluate Fair Use</button>
  <div id="result"></div>
</div>


<!-- RESOURCES SECTION -->
<div id="resources" class="section">
  <h1>Learn More</h1>
  <ul>
    <li><a href="https://fairuse.stanford.edu/" target="_blank">Stanford Fair Use Center</a></li>
    <li><a href="https://www.copyright.gov/fair-use/" target="_blank">U.S. Copyright Office</a></li>
    <li><a href="https://www.law.cornell.edu/uscode/text/17/107" target="_blank">17 USC §107</a></li>
  </ul>
</div>


<!-- PROCESS SECTION -->
<div id="process" class="section">
  <h1>How This Calculator Works</h1>
  
  <div class="intro-card">
    <h2>Why we built this</h2>
    <p>
      Fair use is one of the most important and confusing parts of copyright law. If you make or post videos online, you have probably asked yourself some version of "Is this fair use or will it get taken down?" The law does not give a simple checklist but rather looks at flexible factors and balances them in context. This calculator is meant to turn the abstract legal test into something you can explore interactively. Instead of giving a definitive answer of whether something is fair use, the calculator will help you think through how the fair use factors apply to a specific video and where your choices might create more or less risk. This calculator is focused on videos because that is where a lot of real world fair use questions show up such as reaction videos, commentary, parodies, fan edits, and remixes that reuse other people's clips or audio.
    </p>
  </div>

  <div class="intro-card">
    <h2>How the calculator works</h2>
    <p>
      The calculator is built around four statutory fair use factors, plus a "fifth factor" that captures how judges and juries react in close cases:
    </p>
    <p>
      <b>Factor 1 - Purpose and character of your use:</b> This is about what you are trying to do with the original work and how you do it. Courts ask whether your use is transformative, whether it adds new meaning or message, and whether it is commercial or noncommercial.
    </p>
    <p>
      <b>Factor 2 - Nature of the copyrighted work:</b> This looks at what kind of work you are using. Courts tend to give more protection to highly creative works like music videos and fiction than to factual works like news clips or instructional videos.
    </p>
    <p>
      <b>Factor 3 - Amount and substantiality used:</b> This factor is about how much you use and how important that portion is. Using a small piece can favor fair use, but even a short clip can be risky if it is the "heart" of the work.
    </p>
    <p>
      <b>Factor 4 - Effect on the market for the original:</b> This asks whether the new video could replace the original or harm its current or potential markets. Courts care a lot about whether your use is a substitute that reduces sales, streams or licensing.
    </p>
    <p>
      <b>Factor 5 - Fifth factor, are you acting in good or bad faith:</b> Officially, courts are not supposed to decide based on whether they "like" you, but in close cases they do react to tone, intent, and fairness. A video that feels cruel, exploitative, or sloppy about rights is more likely to be treated harshly.
    </p>
  </div>

  <div class="intro-card">
    <h2>How to use the calculator</h2>
    <p>
      For each factor, you will answer five short questions about your video. Every question uses a sliding scale from 1-9 with a score of 1 meaning that "this choice is very friendly to fair use." Conversely, a score of 9 means "this choice looks more like infringement risk." For example, for the "amount used" factor, a question might ask how much of the original audio you use. Sliding to 1 means "none of the original audio," and sliding to 9 means "the entire original audio track." We chose a 1-9 scale instead of yes or no answers because fair use is almost never all or nothing. Courts talk about uses being more or less transformative, more or less commercial, or using more or less of the original. As Brad Rosen repeatedly put it, "Where do you draw the line?" A slider lets you place your video somewhere on the spectrum instead of forcing a simple yes or no.
    </p>
  </div>

  <div class="intro-card">
    <h2>Why five questions per factor</h2>
    <p>
      Each factor covers more than one idea. For example, the first factor is not just "commercial or noncommercial." It also includes transformation, commentary, and parody. If there was only one question per factor, the law would be grossly oversimplified. Five questions per factor lets the calculator touch on different aspects courts actually look at while keeping the quiz short enough to finish in a few minutes.
    </p>
  </div>

  <div class="intro-card">
    <h2>How scoring works</h2>
    <p>
      After you answer all 25 questions, the calculator does two things.
    </p>
    <p>
      <b>Factor scores:</b> For each factor, we take the average of your five answers. This gives you 5 scores between 1-9, one per factor. Lower scores suggest the facts you reported are more friendly to a fair use argument for that factor. Higher scores suggest more risk on that factor.
    </p>
    <p>
      <b>Overall risk score:</b> The five factor scores are then combined into one overall "risk" score. In our basic version, a weighted average is used where Factor 1 and Factor 4 are weighted a little more while Factor 2 and Factor 3 carry moderate weight and Factor 5 carries a little less weight. This reflects how courts often treat transformation and market harm as especially important, while also recognizing that tone and good faith can influence close cases. Your resulting score will fall into three bands.
    </p>
    <ul style="margin-left: 20px; line-height: 1.8;">
      <li><b>1 to 3:</b> leans toward fair use</li>
      <li><b>4 to 6:</b> is mixed or uncertain</li>
      <li><b>7 to 9:</b> factor leans against fair use</li>
    </ul>
  </div>

  <div class="intro-card">
    <h2>What this tool is and what it is not</h2>
    <p>
      This tool is meant to be a teaching and reflection aid, allowing you to see how different choices affect each fair use factor as well as a way to connect your own video ideas to the fair use test that courts use. This tool is not legal advice, a guarantee that any given video is or is not fair use, or a substitute for talking to a lawyer in a real dispute. The scores and blurbs are based on typical patterns in fair use cases, but real outcomes always depend on specific facts, context, and the court involved. Videos with similar answers could still be treated differently in the real world.
    </p>
  </div>
</div>


<!-- TRAINING DATA SECTION -->
<div id="training" class="section">
  <h1>Add Training Data</h1>
  <div class="subtitle">
    Enter a court case with its answers and label (fair use or not fair use) to build your training dataset.
  </div>

  <div class="intro-card">
    <h2>Instructions</h2>
    <p>
      <b>1.</b> Enter the name of the court case (e.g., "Campbell v. Acuff-Rose Music, 510 U.S. 569 (1994)")<br>
      <b>2.</b> Answer all 25 questions based on how the court case was decided<br>
      <b>3.</b> Select whether the case was ruled as <b>Fair Use</b> or <b>Not Fair Use</b><br>
      <b>4.</b> Click "Save Case" to add it to the database
    </p>
  </div>

  <input type="text" id="caseNameInput" class="case-name-input" placeholder="Enter case name (e.g., Campbell v. Acuff-Rose Music, 510 U.S. 569 (1994))">

  <div class="label-selection">
    <div class="label-option" data-label="1" onclick="selectLabel(1)">
      ✓ Fair Use
    </div>
    <div class="label-option" data-label="0" onclick="selectLabel(0)">
      ✗ Not Fair Use
    </div>
  </div>

  <div id="trainingQuestionContainer"></div>
  <button type="button" onclick="saveTrainingCase()">Save Case</button>
  <div id="saveMessage" class="save-message"></div>
</div>


<!-- ADMIN SECTION -->
<div id="admin" class="section">
  <h1>Admin - View Training Data</h1>
  <div class="subtitle">
    View, manage, and export your training dataset.
  </div>

  <div class="admin-controls">
    <button type="button" onclick="loadAdminData()">Refresh Data</button>
    <button type="button" class="btn-train" onclick="trainModel()">Train Model</button>
    <button type="button" class="btn-export" onclick="exportTrainingData()">Export JSON</button>
  </div>
  <div id="trainMessage" class="save-message"></div>

  <div id="statsContainer" class="stats"></div>
  <div id="casesContainer" class="cases-list"></div>
</div>


<script>
function showTab(tab){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  if(tab === 'admin'){
    loadAdminData();
  }
  if(tab === 'training'){
    // Reset training form when switching to it
    document.getElementById('caseNameInput').value = '';
    selectedLabel = null;
    document.querySelectorAll('.label-option').forEach(opt => opt.classList.remove('selected'));
    renderTrainingQuestions();
  }
}
</script>


<!-- ALL YOUR ORIGINAL JAVASCRIPT EXACTLY BELOW -->
<script>
// Base URL for API calls:
// - When opened from a file (file://), talk to local Flask at 127.0.0.1:5000
// - When hosted on a server (http/https), use same origin (empty prefix)
const API_BASE = window.location.protocol === 'file:' ? 'http://127.0.0.1:5000' : '';

// =====================================================
// CONFIGURATION
// =====================================================

// Plain-English question texts (1–25)
const questionTexts = {
  // Factor 1: Purpose & Character
  1: "How transformative is your video compared to the original?",
  2: "How much does your video comment on, critique, or parody the original work?",
  3: "What is the main purpose of your video?",
  4: "How much creative effort did you put into elements that are not from the original work?",
  5: "How would you describe your intent in using the original material?",

  // Factor 2: Nature of the Work
  6: "How creative is the original work you are using?",
  7: "Was the original work published before you used it?",
  8: "How \"finished\" is the original work?",
  9: "Does your video rely on the most creative aspects of the original, or mainly on factual parts?",
  10: "Is the original work the kind courts tend to give strong protection to?",

  // Factor 3: Amount & Substantiality
  11: "How much of the original video's total running time do you use?",
  12: "How much of the original audio do you use?",
  13: "Do you use the \"heart\" of the original work, the most memorable or important part?",
  14: "Are the copied parts continuous or broken up?",
  15: "Could someone watch your video instead of the original and feel like they have \"seen it\"?",

  // Factor 4: Market Effect
  16: "How likely is it that your video could replace the original for most viewers?",
  17: "Does your video target the same audience as the original work?",
  18: "How does your video affect people's reasons to watch or buy the original?",
  19: "Is your video posted in the same type of market space as the original?",
  20: "Could your video harm current or potential licensing markets for the original?",

  // Factor 5: Other considerations
  21: "How respectful is the overall tone of your video toward the people or works you are using?",
  22: "How would a judge or jury likely feel about your motives if they watched the video?",
  23: "How honestly do you present your relationship to the original work and its owner?",
  24: "Do you rely on disclaimers or \"no copyright intended\" type statements instead of thinking through fair use?",
  25: "If the original creator saw your video, how likely is it that they would feel you acted unfairly or in bad faith?"
};

// Reverse-scored questions (1..25) if any (e.g., where 9 is worst, 1 is best)
const reverseQuestions = [
  // Example: 15, 19
];

// Scale descriptions for each question (1-9 endpoints)
const scaleDescriptions = {
  1: { low: "My video adds a new message, meaning, or purpose and clearly changes how people experience the original", high: "My video keeps the same message and purpose as the original and mostly just copies it" },
  2: { low: "The main point of my video is to comment on, critique, or parody the original", high: "My video does not comment on the original at all and just uses it as content or background" },
  3: { low: "Noncommercial, educational, or purely personal use with no money involved", high: "Commercial use where I am trying to make money or promote a brand with this video" },
  4: { low: "Most of the value in my video comes from my own new scripting, editing, performance, or commentary", high: "Most of the value in my video comes from the original clip or song, and I added very little" },
  5: { low: "I used it in good faith to inform, educate, or meaningfully transform the original", high: "I used it mainly because it is popular and attention grabbing, without much transformation" },
  6: { low: "The original is mostly factual or informational", high: "The original is highly creative, like a music video, movie, or scripted show" },
  7: { low: "It was already widely published and publicly available", high: "It was not yet published or was hard to access when I used it" },
  8: { low: "The original is a simple or raw piece of content, like a news clip or short update", high: "The original is a polished, fully produced work that involved significant creative effort" },
  9: { low: "I mainly rely on factual or low creativity parts of the original", high: "I rely heavily on the most creative and expressive parts of the original" },
  10: { low: "The original is more like news, information, or instructions", high: "The original is more like music, film, animation, or fiction" },
  11: { low: "I use no footage or only very short clips compared to the full length", high: "I use most or all of the original video's running time" },
  12: { low: "I use none of the original audio, or only very short snippets", high: "I use most or all of the original audio track" },
  13: { low: "I avoid the most memorable parts and use less central sections", high: "I focus on the most recognizable or iconic parts of the original" },
  14: { low: "I only use brief, broken up clips mixed with a lot of my own material", high: "I use long, continuous segments of the original with little interruption" },
  15: { low: "No, my video does not let someone experience the original as a substitute", high: "Yes, someone could watch mine and feel no need to watch the original" },
  16: { low: "Very unlikely, my video serves a different purpose and audience", high: "Very likely, my video could serve as a direct replacement for the original" },
  17: { low: "My video is aimed at a different audience or community", high: "My video targets the same audience as the original" },
  18: { low: "It encourages people to watch, buy, or subscribe to the original", high: "It makes people less likely to pay for or watch the original" },
  19: { low: "It appears in a different setting, such as an educational site or a niche channel", high: "It appears in the same kind of space as the original, such as a mainstream commercial platform competing for views" },
  20: { low: "It is unlikely to interfere with any normal or expected licensing for the original", high: "It could easily undercut or replace typical licensing uses of the original" },
  21: { low: "The tone is critical or playful but not hateful, cruel, or needlessly offensive", high: "The tone is harsh, degrading, or likely to be seen as morally offensive or abusive" },
  22: { low: "It would look like you acted in good faith, with a clear expressive or educational purpose", high: "It would look like you acted mainly to provoke, shock, or take advantage of someone else's work or reputation" },
  23: { low: "You are clear that you are not the original creator, and you do not pretend to be endorsed or authorized", high: "You blur or hide the fact that this is someone else's work, or suggest endorsement that does not exist" },
  24: { low: "I do not rely on disclaimers to justify my use, and I have tried to understand the fair use factors", high: "I mostly assume that writing a disclaimer or \"fair use\" in the description will protect me, even if the video is basically a copy" },
  25: { low: "They might disagree with my use, but they would likely see a real transformative point or commentary", high: "They would likely feel I exploited their work or reputation without adding meaningful value" }
};

// Weights for each question (index 1..25)
const weights = Array(26).fill(1);

// Factor 1 (Purpose & Character)
weights[1] = 3;
weights[2] = 3;
weights[3] = 3;
weights[4] = 2;
weights[5] = 2;

// Factor 2 (Nature of the Work)
weights[6] = 2;
weights[7] = 1;
weights[8] = 1;
weights[9] = 1;
weights[10] = 2;

// Factor 3 (Amount & Substantiality)
weights[11] = 2;
weights[12] = 2;
weights[13] = 2;
weights[14] = 2;
weights[15] = 1;

// Factor 4 (Market Effect)
weights[16] = 3;
weights[17] = 3;
weights[18] = 2;
weights[19] = 3;
weights[20] = 3;

// Factor 5 (Other considerations)
weights[21] = 1;
weights[22] = 1;
weights[23] = 2;
weights[24] = 2;
weights[25] = 1;

// Factor groupings (you can change which questions belong to which factor)
const factorAssignments = {
  purpose: [1,2,3,4,5],
  nature:  [6,7,8,9,10],
  amount:  [11,12,13,14,15],
  market:  [16,17,18,19,20],
  other:   [21,22,23,24,25]
};

const factorMeta = {
  purpose: {
    title: "Factor 1 — Purpose & Character of the Use",
    tagline: "How transformative and goal-driven your use is."
  },
  nature: {
    title: "Factor 2 — Nature of the Copyrighted Work",
    tagline: "How factual, published, and information-oriented the source is."
  },
  amount: {
    title: "Factor 3 — Amount & Substantiality",
    tagline: "How much you took and whether you avoided the core of the work."
  },
  market: {
    title: "Factor 4 — Effect on the Market",
    tagline: "Whether your use competes with or harms the original’s market."
  },
  other: {
    title: "Other Fair Use Considerations",
    tagline: "Good faith, clarity, and how your use might be perceived."
  }
};

// Per-factor descriptions
const factorDescriptions = {
  purpose: {
    low:  "Your answers suggest that the purpose and character of your video are friendly to fair use. You describe a use that is relatively transformative, adds your own creativity or commentary, and does not simply reuse the original for the same purpose. These choices tend to support a fair use argument on this factor.",
    med:  "On Factor 1, your answers fall in the middle. Some details point toward transformation or commentary, while others look closer to straightforward copying or commercial use. A court could see the purpose and character of your video either way, so changes here could meaningfully strengthen or weaken a fair use claim.",
    high: "Your answers suggest that the purpose and character of your video lean against fair use. The use looks closer to using the original for the same purpose, with limited transformation or commentary, and may be primarily commercial. This would likely be a weak point in a fair use argument."
  },
  nature: {
    low:  "Your answers suggest that the original work is more factual, informational, or less creatively expressive. Courts are generally more open to fair use when the source material is factual or published, so this factor would tend to support your fair use argument.",
    med:  "On Factor 2, your answers sit in the middle. The original work has both factual and creative elements, or it is creative but already widely published. This factor would probably not be decisive either way and may carry less weight compared to the other factors in your situation.",
    high: "Your answers suggest that the original work is highly creative, polished, and expressive, such as a music video, film, or scripted show, and possibly not widely available at the time of use. Courts tend to give stronger protection to this kind of work, so this factor would likely weigh against fair use."
  },
  amount: {
    low:  "Your answers suggest that you used a relatively small portion of the original or avoided its most important and memorable parts. You may also have broken the material into short clips surrounded by your own content. This limited and careful use tends to support a fair use argument on this factor.",
    med:  "On Factor 3, your answers indicate that you used a moderate amount of the original, or included some key moments but not in a way that completely replaces the original. A court could see this as reasonable for your purpose, or as more than needed. This factor is neither clearly helpful nor clearly harmful to your fair use claim.",
    high: "Your answers suggest that you used a large portion of the original work, possibly including its most iconic or central parts, in long or continuous segments. Someone might be able to experience most of the original by watching your video. This level of copying would likely weigh against fair use on this factor."
  },
  market: {
    low:  "Your answers suggest that your video is not likely to harm the market for the original work. It seems to serve a different purpose or audience, may encourage viewers to seek out the original, and is unlikely to replace normal sales, streams, or licenses. This tends to support a fair use argument on this factor.",
    med:  "On Factor 4, your answers show that the market impact is not clear. Your video might overlap somewhat with the original's audience or viewing spaces, but it is not an obvious substitute. A court would likely look closely at real world evidence here. This factor could become more or less risky depending on how and where the video is shared.",
    high: "Your answers suggest that your video could act as a substitute for the original or interfere with its normal markets or licensing opportunities. It may target the same audience on the same platforms and could reduce the need to watch or pay for the original. Courts take market harm seriously, so this factor would likely weigh strongly against fair use."
  },
  other: {
    low:  "Your answers suggest that you look like a \"good actor\" in the eyes of a judge or jury. The tone of your video is not needlessly cruel or hateful, you are honest about your relationship to the original work, and you are not just hiding behind disclaimers. Even though this is not an official factor, this kind of good faith behavior can make a court more comfortable with a fair use argument in a close case.",
    med:  "On Factor 5, your results are in the middle. Nothing about your video screams obvious bad faith, but there are also choices that might raise questions about tone, honesty, or motives. In a close case, a judge or jury might see your behavior as neutral rather than clearly sympathetic. This does not decide fair use by itself, but it does not give you much extra help.",
    high: "Your answers suggest that a judge or jury could see you as acting in bad faith. The tone may feel harsh or exploitative, you may blur or misrepresent your connection to the original, or you may be relying on \"no copyright intended\" type language instead of thinking through fair use. Courts officially should not punish people just for being offensive, but in practice this kind of behavior can make them more willing to rule against fair use when the other factors are close."
  }
};

// Overall descriptions
const overallDescriptions = {
  low:  "Overall, your answers suggest a relatively strong fair use argument. Several factors lean in your favor and your choices look more like transformation or commentary than substitution. This does not guarantee fair use in court, but it means your video has many fair use friendly features.",
  med:  "Overall, your answers point to a mixed picture. Some factors lean toward fair use while others lean toward infringement. A court could go either way, and small changes in how you use the original video or audio might push your situation in a clearer direction.",
  high: "Overall, your answers suggest a higher risk that your video would be seen as infringement rather than fair use. Several factors lean against fair use and your use of the original work looks more like a substitute than a new, transformative work. This does not mean you would automatically lose in court, but it does mean your fair use argument is relatively weak."
};

// =====================================================
// RENDER QUESTIONS
// =====================================================

function renderQuestions() {
  const container = document.getElementById("questionContainer");
  for (let i = 1; i <= 25; i++) {
    const block = document.createElement("div");
    block.className = "question-block";
    const scale = scaleDescriptions[i] || { low: "1 (less supportive)", high: "9 (more supportive)" };
    block.innerHTML = `
      <div class="question-label"><b>Q${i}.</b> ${questionTexts[i]}</div>
      <input type="range" min="1" max="9" value="5" id="q${i}"
             oninput="document.getElementById('v${i}').innerText=this.value">
      <div class="label-row">
        <span style="font-size: 12px;">1: ${scale.low}</span>
        <span class="score-value" id="v${i}">5</span>
        <span style="font-size: 12px;">9: ${scale.high}</span>
      </div>
    `;
    container.appendChild(block);
  }
}

renderQuestions();

// =====================================================
// SCORING
// =====================================================

async function calculateScore() {
  const original = [];
  const normalized = [];

  // collect answers
  for (let i = 1; i <= 25; i++) {
    let val = parseFloat(document.getElementById("q" + i).value);
    if (isNaN(val)) val = 5;
    original.push(val);

    let norm = reverseQuestions.includes(i) ? 10 - val : val;
    normalized.push(norm);
  }

  // manual overall score (0–100)
  let weightedSum = 0;
  let totalWeight = 0;
  for (let i = 1; i <= 25; i++) {
    weightedSum += normalized[i-1] * weights[i];
    totalWeight += weights[i];
  }
  const minPossible = 1 * totalWeight;
  const maxPossible = 9 * totalWeight;
  const manualPercent = ((weightedSum - minPossible) / (maxPossible - minPossible)) * 100;

  // call ML backend
  let mlPercent = NaN;
  try {
    const response = await fetch(API_BASE + "/predict", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers: original })
    });
    const mlResult = await response.json();
    mlPercent = mlResult.score * 100;
  } catch (_) {
    mlPercent = NaN;
  }

  // per-factor scores
  const factorScores = {};
  for (const key in factorAssignments) {
    const qList = factorAssignments[key];
    let wSum = 0, wTot = 0;
    for (const q of qList) {
      wSum += normalized[q-1] * weights[q];
      wTot += weights[q];
    }
    const fMin = 1 * wTot;
    const fMax = 9 * wTot;
    factorScores[key] = ((wSum - fMin) / (fMax - fMin)) * 100;
  }

  // overall description
  let overallText;
  if (manualPercent < 33.333) overallText = overallDescriptions.low;
  else if (manualPercent < 66.666) overallText = overallDescriptions.med;
  else overallText = overallDescriptions.high;

  // build result HTML
  let html = `
    <div class="results-card">
      <div class="results-title">Overall Fair Use Risk Assessment</div>
      <div class="results-sub">These scores are educational only and do not constitute legal advice.</div>

      <div class="score-row">
        <div class="score-label">Manual score (based on your answers):</div>
        <div class="score-number">${manualPercent.toFixed(1)}%</div>
      </div>
      <div class="bar-container">
        <div class="bar" style="width:${Math.max(0, Math.min(100, manualPercent))}%;"></div>
      </div>
  `;

  if (!Number.isNaN(mlPercent)) {
    html += `
      <div class="score-row">
        <div class="score-label">AI model score (0–100):</div>
        <div class="score-number">${mlPercent.toFixed(1)}%</div>
      </div>
      <div class="bar-container">
        <div class="bar" style="width:${Math.max(0, Math.min(100, mlPercent))}%;"></div>
      </div>
    `;
  } else {
    html += `
      <div class="score-row">
        <div class="score-label">AI model score:</div>
        <div class="score-number" style="opacity:0.7;">not available (server not running)</div>
      </div>
    `;
  }

  html += `
      <div class="overall-description">${overallText}</div>
      <div class="disclaimer">
        This tool is for teaching and discussion only. Only a court can make a binding fair use determination.
      </div>
    </div>
  `;

  // add factor blocks
  for (const key in factorScores) {
    const p = factorScores[key];
    const desc = p < 33.333 ? factorDescriptions[key].low :
                 p < 66.666 ? factorDescriptions[key].med : factorDescriptions[key].high;
    const meta = factorMeta[key];

    html += `
      <div class="factor-block">
        <div class="factor-title">${meta.title}</div>
        <div class="factor-tagline">${meta.tagline}</div>
        <div class="score-row">
          <div class="score-label">Score for this factor:</div>
          <div class="score-number">${p.toFixed(1)}%</div>
        </div>
        <div class="bar-container">
          <div class="bar" style="width:${Math.max(0, Math.min(100, p))}%;"></div>
        </div>
        <div class="factor-text">${desc}</div>
      </div>
    `;
  }

  document.getElementById("result").innerHTML = html;
}

// =====================================================
// TRAINING DATA FUNCTIONS
// =====================================================

let selectedLabel = null;

function renderTrainingQuestions() {
  const container = document.getElementById("trainingQuestionContainer");
  container.innerHTML = ''; // Clear existing
  for (let i = 1; i <= 25; i++) {
    const block = document.createElement("div");
    block.className = "question-block";
    const scale = scaleDescriptions[i] || { low: "1 (less supportive)", high: "9 (more supportive)" };
    block.innerHTML = `
      <div class="question-label"><b>Q${i}.</b> ${questionTexts[i]}</div>
      <input type="range" min="1" max="9" value="5" id="tq${i}"
             oninput="document.getElementById('tv${i}').innerText=this.value">
      <div class="label-row">
        <span style="font-size: 12px;">1: ${scale.low}</span>
        <span class="score-value" id="tv${i}">5</span>
        <span style="font-size: 12px;">9: ${scale.high}</span>
      </div>
    `;
    container.appendChild(block);
  }
}

function selectLabel(label) {
  selectedLabel = label;
  document.querySelectorAll('.label-option').forEach(opt => {
    opt.classList.remove('selected');
    if(parseInt(opt.dataset.label) === label) {
      opt.classList.add('selected');
    }
  });
}

async function saveTrainingCase() {
  const caseName = document.getElementById('caseNameInput').value.trim();
  if (!caseName) {
    showSaveMessage('Please enter a case name', 'error');
    return;
  }
  if (selectedLabel === null) {
    showSaveMessage('Please select whether this is Fair Use or Not Fair Use', 'error');
    return;
  }

  const answers = [];
  for (let i = 1; i <= 25; i++) {
    const val = parseFloat(document.getElementById(`tq${i}`).value);
    answers.push(isNaN(val) ? 5 : val);
  }

  try {
    const response = await fetch(API_BASE + '/api/add-case', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        case_name: caseName,
        answers: answers,
        label: selectedLabel
      })
    });

    const result = await response.json();
    if (response.ok) {
      showSaveMessage(`✓ Case saved successfully! (ID: ${result.id})`, 'success');
      // Reset form
      document.getElementById('caseNameInput').value = '';
      selectedLabel = null;
      document.querySelectorAll('.label-option').forEach(opt => opt.classList.remove('selected'));
      renderTrainingQuestions();
    } else {
      showSaveMessage(`Error: ${result.error}`, 'error');
    }
  } catch (error) {
    showSaveMessage(`Error: Could not connect to server. Make sure Flask is running.`, 'error');
  }
}

function showSaveMessage(message, type) {
  const msgDiv = document.getElementById('saveMessage');
  msgDiv.textContent = message;
  msgDiv.className = `save-message ${type}`;
  setTimeout(() => {
    msgDiv.className = 'save-message';
  }, 5000);
}

// =====================================================
// ADMIN FUNCTIONS
// =====================================================

async function loadAdminData() {
  try {
    const response = await fetch(API_BASE + '/api/cases');
    const result = await response.json();
    
    if (!response.ok) {
      document.getElementById('casesContainer').innerHTML = `<p style="color:#ff5757;">Error: ${result.error}</p>`;
      return;
    }

    const cases = result.cases;
    
    // Update stats
    const totalCases = cases.length;
    const fairUseCount = cases.filter(c => c.label === 1).length;
    const notFairUseCount = cases.filter(c => c.label === 0).length;
    
    document.getElementById('statsContainer').innerHTML = `
      <div class="stat-item">
        <div class="stat-number">${totalCases}</div>
        <div class="stat-label">Total Cases</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:#6BCB77;">${fairUseCount}</div>
        <div class="stat-label">Fair Use</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" style="color:#ff5757;">${notFairUseCount}</div>
        <div class="stat-label">Not Fair Use</div>
      </div>
    `;

    // Display cases
    if (cases.length === 0) {
      document.getElementById('casesContainer').innerHTML = `
        <div style="text-align:center; padding:40px; opacity:0.7;">
          No cases in database yet. Add some in the Training Data tab!
        </div>
      `;
      return;
    }

    let html = '';
    cases.forEach(c => {
      const date = new Date(c.created_at).toLocaleString();
      const labelText = c.label === 1 ? '<span style="color:#6BCB77; font-weight:600;">✓ Fair Use</span>' : 
                                       '<span style="color:#ff5757; font-weight:600;">✗ Not Fair Use</span>';
      html += `
        <div class="case-item">
          <div class="case-info">
            <h3>${c.case_name}</h3>
            <p>${labelText}</p>
            <p>Added: ${date} | ID: ${c.id}</p>
          </div>
          <div class="case-actions">
            <button class="btn-delete" onclick="deleteCase(${c.id})">Delete</button>
          </div>
        </div>
      `;
    });
    document.getElementById('casesContainer').innerHTML = html;

  } catch (error) {
    document.getElementById('casesContainer').innerHTML = `
      <p style="color:#ff5757;">Error: Could not connect to server. Make sure Flask is running.</p>
    `;
  }
}

async function deleteCase(caseId) {
  if (!confirm('Are you sure you want to delete this case?')) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/api/cases/${caseId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    if (response.ok) {
      loadAdminData(); // Refresh the list
    } else {
      alert(`Error: ${result.error}`);
    }
  } catch (error) {
    alert('Error: Could not connect to server.');
  }
}

async function trainModel() {
  const trainBtn = document.querySelector('.btn-train');
  const msgDiv = document.getElementById('trainMessage');
  
  if (!confirm('Train the logistic regression model on all current training data? This may take a few seconds.')) {
    return;
  }
  
  trainBtn.disabled = true;
  trainBtn.textContent = 'Training...';
  msgDiv.textContent = 'Training model, please wait...';
  msgDiv.className = 'save-message';
  msgDiv.style.display = 'block';
  
  try {
    const response = await fetch(API_BASE + '/api/train-model', {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      msgDiv.textContent = '✓ Model trained successfully! You can now use AI predictions in the Quiz tab.';
      msgDiv.className = 'save-message success';
      
      // Show training output if available
      if (result.output) {
        console.log('Training output:', result.output);
      }
    } else {
      const errorMsg = result.error || 'Training failed';
      const output = result.output || 'No output available';
      msgDiv.textContent = `Error: ${errorMsg}`;
      msgDiv.className = 'save-message error';
      console.error('Training failed:', errorMsg);
      console.error('Output:', output);
      
      // Show output in alert if available (truncate if too long)
      if (output && output.trim()) {
        const shortOutput = output.length > 500 ? output.substring(0, 500) + '...' : output;
        alert(`Training Error:\n\n${shortOutput}`);
      }
    }
  } catch (error) {
    msgDiv.textContent = 'Error: Could not connect to server. Make sure Flask is running.';
    msgDiv.className = 'save-message error';
  } finally {
    trainBtn.disabled = false;
    trainBtn.textContent = 'Train Model';
    setTimeout(() => {
      msgDiv.style.display = 'none';
    }, 10000);
  }
}

async function exportTrainingData() {
  try {
    const response = await fetch(API_BASE + '/api/export-cases');
    const result = await response.json();
    
    if (!response.ok) {
      alert(`Error: ${result.error}`);
      return;
    }

    // Create downloadable JSON file
    const dataStr = JSON.stringify(result, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `training_data_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    alert(`Exported ${result.count} cases successfully!`);
  } catch (error) {
    alert('Error: Could not connect to server.');
  }
}

</script>

</body>
</html>
